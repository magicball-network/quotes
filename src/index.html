<!doctype html>
<html lang="en" data-bs-theme="dark" class="min-vh-100">
	<head>
		<meta charset="utf-8" />
		<title>Little Big Adventure Game Quotes (&alpha;lpha)</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link
			rel="stylesheet"
			href="https://magicball.net/assets/css/bundle.css"
		/>
		<script async src="https://magicball.net/assets/js/bundle.js"></script>
		<style>
			.quote .message {
				/* Ensure newlines result in new lines */
				white-space: pre-line;
			}

			.quote .portrait {
				border-image: radial-gradient(
						ellipse at center,
						#f1e767 0%,
						#feb645 100%
					)
					5 !important;
			}
		</style>
	</head>

	<body class="d-flex flex-column min-vh-100">
		<header
			class="navbar navbar-expand-lg sticky-top bg-body-secondary"
			_style="--bs-bg-opacity: .9;"
		>
			<nav class="container">
				<a class="navbar-brand" href="https://magicball.net">
					<picture>
						<source
							type="image/webp"
							srcset="https://magicball.net/assets/logo.webp"
						/>
						<img
							src="https://magicball.net/assets/logo.png"
							alt="Magicball Network"
							height="50"
						/>
					</picture>
				</a>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent"
					aria-controls="navbarSupportedContent"
					aria-expanded="false"
					aria-label="Toggle navigation"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div
					class="collapse navbar-collapse"
					id="navbarSupportedContent"
				>
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li class="nav-item text-nowrap">
							<a
								class="nav-link icon-link"
								href="https://magicball.net"
							>
								<img
									src="https://magicball.net/assets/favicon-64.png"
									class="nav-icon"
									height="24"
									width="24"
									alt=""
									aria-hidden="true"
								/>
								Home
							</a>
						</li>
						<li class="nav-item text-nowrap">
							<a
								class="nav-link icon-link"
								href="https://forum.magicball.net"
							>
								<img
									src="https://magicball.net/assets/talk.png"
									class="nav-icon"
									height="24"
									width="24"
									alt=""
									aria-hidden="true"
								/>
								Forum
							</a>
						</li>
						<li class="nav-item text-nowrap">
							<a class="nav-link icon-link" href="/">
								<img
									src="quotes.png"
									class="nav-icon"
									height="24"
									width="24"
									alt=""
									aria-hidden="true"
								/>
								Game quotes
							</a>
						</li>
					</ul>
				</div>
			</nav>
		</header>

		<main class="flex-column">
			<div
				class="container bg-body-secondary p-4 header-bg"
				style="background-image: url(headerbg.jpg)"
			>
				<div class="col-12 mx-auto text-center">
					<h1 class="no-anchor" data-toc-skip>
						Little Big Adventure Game Quotes <sup>&alpha;lpha</sup>
					</h1>
				</div>
				<div class="row">
					<div class="col-lg-8 mx-auto">
						This page allows you to search and browse through the
						text displayed in both LBA games. All the in-game text
						is featured, but the information is incomplete. Quotes
						are missing information on who said it, and their more
						exact location. You can suggest edits by submitting
						merge requests or logging issues on the
						<a href="https://github.com/magicball-network/quotes"
							>Github project</a
						>. Press the
						<svg
							class="bi"
							aria-hidden="true"
							height="1rem"
							width="1rem"
						>
							<use xlink:href="#bi-pencil-fill"></use>
						</svg>
						icon in the quote to jump to its source.
					</div>
				</div>
			</div>

			<div class="container bg-body-tertiary py-2">
				<div
					class="row"
					style="position: sticky; top: 76px; z-index: 10"
				>
					<div class="pt-2 bg-body-tertiary">
						<section class="mx-auto col-md-12 col-lg-8 col-xl-6">
							<div class="input-group mb-1">
								<label
									for="gameSelect"
									class="col-sm-2 input-group-text"
									>Game</label
								>
								<select id="gameSelect" class="form-select">
									<option value="">Any</option>
								</select>
							</div>
							<div class="input-group mb-1">
								<label
									for="areaSelect"
									class="col-sm-2 input-group-text"
									>Area</label
								>
								<select id="areaSelect" class="form-select">
									<option value="">Any</option>
								</select>
							</div>
							<form class="input-group mb-1" id="searchForm">
								<label
									for="search"
									class="col-sm-2 input-group-text"
									>Search</label
								>
								<input
									id="search"
									placeholder="Search for a quote"
									type="text"
									class="form-control"
								/>
								<button
									id="searchBtn"
									type="submit"
									class="btn btn-primary"
								>
									Search
								</button>
								<button
									id="randomBtn"
									type="button"
									class="btn btn-success"
								>
									Random
								</button>
							</form>
						</section>
						<div class="mx-auto col-md-12 col-lg-8 col-xl-6 d-none">
							<audio
								id="player"
								class="w-100"
								controls=""
								controlslist="nodownload nofullscreen noremoteplayback"
								preload="none"
							></audio>
						</div>
					</div>
					<div
						class="p-2"
						style="
							background: linear-gradient(
								to bottom,
								rgba(
										var(--bs-tertiary-bg-rgb),
										var(--bs-bg-opacity)
									)
									0%,
								rgba(0, 0, 0, 0) 100%
							);
						"
					></div>
				</div>
				<div class="row" style="z-index: 0">
					<section id="quotes"></section>
				</div>
			</div>
		</main>

		<div class="footer mt-auto bg-body-secondary">
			<footer
				class="container d-flex flex-wrap justify-content-between align-items-center pt-3"
			>
				<p class="col-md-4">
					Service provided by
					<a href="https://magicball.net">Magicball Network</a>
				</p>

				<a
					href="/"
					class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto text-decoration-none"
				>
					<img
						src="https://magicball.net/assets/favicon-32.png"
						alt="Home"
					/>
				</a>

				<p class="col-md-4 text-end">
					Project hosted on
					<a href="https://github.com/magicball-network/quotes"
						>Github</a
					>
				</p>
			</footer>
		</div>

		<svg class="d-none" width="0" height="0" style="position: absolute">
			<symbol
				id="bi-pencil-fill"
				fill="currentColor"
				class="bi bi-pencil-fill"
				viewBox="0 0 16 16"
			>
				<path
					d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"
				/>
			</symbol>
			<symbol
				id="bi-play-btn"
				fill="currentColor"
				class="bi bi-play-btn"
				viewBox="0 0 16 16"
			>
				<path
					d="M6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814z"
				/>
				<path
					d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 0a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1z"
				/>
			</symbol>
		</svg>

		<script id="tmpl-quote" type="x-tmpl-mustache">
			<div class="card quote mb-2">
				<div class="card-body">
					{{#speakerPortrait}}
					<div class="float-end">
						<img src="{{ speakerPortrait }}" alt="" class="bg-gradient border border-5 portrait" title="Portrait of {{speakerTitle}}" />
					</div>
					{{/speakerPortrait}}
					<div class="">
						<dl class="row mb-0">
							<dt class="col-md-2 col-lg-2 col-xl-1 text-nowrap">Game</dt>
							<dd class="col-md-10 col-lg-10 col-xl-11">{{ gameTitle }}</dd>
							<dt class="col-md-2 col-lg-2 col-xl-1 text-nowrap">Quote ID</dt>
							<dd class="col-md-10 col-lg-10 col-xl-11">
								<a href="#{{fqnId}}">{{ id }}</a>
								<a href="https://github.com/magicball-network/quotes/blob/main/{{ sourceFile }}"
									class="text-decoration-none link-success"
									target="_blank"
									title="Edit source"
									>
										<svg class="bi" aria-hidden="true" height="1rem" width="1rem"><use xlink:href="#bi-pencil-fill"></use></svg>
									</a
								>
							</dd>
							<dt class="col-md-2 col-lg-2 col-xl-1 text-nowrap">Area</dt>
							<dd class="col-md-10 col-lg-10 col-xl-11">{{ area }}</dd>
							{{#location}}
							<dt class="col-md-2 col-lg-2 col-xl-1 text-nowrap">Location</dt>
							<dd class="col-md-10 col-lg-10 col-xl-11">{{ location }}</dd>
							{{/location}}
							{{#speaker}}
							<dt class="col-md-2 col-lg-2 col-xl-1 text-nowrap">Speaker</dt>
							<dd class="col-md-10 col-lg-10 col-xl-11">{{ speakerTitle }}</dd>
							{{/speaker}}
							<dt class="col-md-2 col-lg-2 col-xl-1 text-nowrap">
								Quote
								{{#audio}}
									<a class="playQuote link-success" data-fqnId="{{fqnId}}" data-src="{{audio}}" href="#{{fqnId}}" title="Play quote">
										<svg class="bi" aria-hidden="true" height="1rem" width="1rem"><use xlink:href="#bi-play-btn"></use></svg>
									</a>
								{{/audio}}
							</dt>
							<dd class="col-md-10 col-lg-10 col-xl-11 message">{{ message }}</dd>
						</dl>
					</div>
				</div>
			</div>
		</script>

		<script type="module">
			import * as Mustache from "mustache";
			window.Mustache = Mustache;
		</script>

		<script>
			const games = {
				lba1: "Little Big Adventure 1 / Relentless",
				lba2: "Little Big Adventure 2 / Twinsen's Odyssey",
			};
			let speakers = {};
			const quotes = [];
			const quoteIndex = {};
			const areaMap = {};
			let quoteTargetElm;

			async function loadSpeakers() {
				let response = await fetch("characters.json");
				if (response.ok) {
					speakers = await response.json();
				} else {
					console.error("Loading characters.json: {}", response);
				}
			}

			async function retrieveQuotes(game) {
				areaMap[game] = new Set();
				let response = await fetch(game + ".json");
				if (response.ok) {
					for (let quote of await response.json()) {
						quote["fqnId"] = game + ":" + quote.id;
						quote["game"] = game;
						quote["gameTitle"] = () => games[game];
						quote["sourceFile"] =
							game +
							"/" +
							quote.id.split(":").join("/") +
							".yaml";
						const speaker = quote["speaker"] || false;
						quote["speakerTitle"] = () => {
							if (speaker && speakers[game][speaker]["name"]) {
								return speakers[game][speaker]["name"];
							} else {
								return speaker;
							}
						};
						quote["speakerPortrait"] = () => {
							if (speaker && speakers[game][speaker]["img"]) {
								return speakers[game][speaker]["img"];
							} else {
								return false;
							}
						};
						quotes.push(quote);
						quoteIndex[quote.fqnId] = quote;
						areaMap[game].add(quote.area);
					}
				} else {
					console.error(
						"Loading quotes for {} failed: {}",
						game,
						response,
					);
				}
			}

			async function loadQuotes() {
				return Promise.all([
					retrieveQuotes("lba1"),
					retrieveQuotes("lba2"),
				]);
			}

			function clearQuotes() {
				quoteTargetElm.innerHTML = "";
			}

			function renderQuote(target, quote) {
				const rendered = Mustache.render(
					document.getElementById("tmpl-quote").innerHTML,
					quote,
				);
				target.innerHTML += rendered;
			}

			function playQuote(fqnId, soundSrc) {
				const player = document.getElementById("player");
				player.src = soundSrc;
				player.parentElement.classList.remove("d-none");
				player.play();
			}

			function augmentPlayButtons(quoteTargetElm) {
				for (let playBtn of quoteTargetElm.querySelectorAll(
					".playQuote",
				)) {
					playBtn.addEventListener("click", (e) => {
						for (let cards of quoteTargetElm.querySelectorAll(
							".card.quote",
						)) {
							cards.classList.remove("border-success");
						}
						playBtn
							.closest(".card")
							.classList.add("border-success");
						e.preventDefault();
						playQuote(playBtn.dataset.fqnId, playBtn.dataset.src);
						playBtn.blur();
					});
				}
			}

			function normalizeString(str) {
				return str
					.normalize("NFD")
					.replace(/[\u0300-\u036f]/g, "")
					.replace(/\s+/g, " ")
					.toLowerCase();
			}

			function matchesQuote(quote, params) {
				if (!quote) {
					return false;
				}
				if (!params) {
					return true;
				}
				if (params.area) {
					let area = params.area.split(":", 2);
					if (
						!area ||
						quote.game !== area[0] ||
						quote.area !== area[1]
					) {
						return false;
					}
				} else if (params.game && params.game !== quote.game) {
					return false;
				}
				if (params.query) {
					if (!quote.searchMessage) {
						quote.searchMessage = normalizeString(quote.message);
					}
					if (
						!quote.searchMessage.includes(
							params.query.toLowerCase(),
						)
					) {
						return false;
					}
				}
				return true;
			}

			function findQuotes(params) {
				let cnt = 0;
				for (let quote of quotes) {
					if (matchesQuote(quote, params)) {
						renderQuote(quoteTargetElm, quote);
						++cnt;
					}
					if (cnt >= 50) {
						break;
					}
				}
			}

			function searchQuotes(event) {
				if (event) {
					event.preventDefault();
				}
				const query = normalizeString(
					document.getElementById("search").value,
				);
				if (!query) {
					return;
				}
				clearQuotes();
				findQuotes({
					game: document.getElementById("gameSelect").value,
					area: document.getElementById("areaSelect").value,
					query: query,
				});
				augmentPlayButtons(quoteTargetElm);
			}

			function randomQuote() {
				const params = {
					game: document.getElementById("gameSelect").value,
					area: document.getElementById("areaSelect").value,
				};
				while (true) {
					let idx = Math.round(Math.random() * quotes.length);
					let quote = quotes[idx];
					if (matchesQuote(quote, params)) {
						clearQuotes();
						renderQuote(quoteTargetElm, quote);
						augmentPlayButtons(quoteTargetElm);
						return;
					}
				}
			}

			function specificQuote(fqnId) {
				clearQuotes();
				if (quoteIndex[fqnId]) {
					renderQuote(quoteTargetElm, quoteIndex[fqnId]);
					augmentPlayButtons(quoteTargetElm);
				}
			}

			function initUi() {
				quoteTargetElm = document.getElementById("quotes");
				document.getElementById("player").volume = 0.5;

				const gameSelect = document.getElementById("gameSelect");
				for (let game of Object.keys(games)) {
					const gameElm = document.createElement("option");
					gameElm.value = game;
					gameElm.textContent = games[game];
					gameSelect.appendChild(gameElm);
				}
				const areaSelect = document.getElementById("areaSelect");
				for (let game of Object.keys(areaMap)) {
					const gameElm = document.createElement("optgroup");
					gameElm.label = games[game];
					gameElm.id = "areaSelectGroup" + game;
					for (let area of areaMap[game]) {
						const areaElm = document.createElement("option");
						areaElm.value = game + ":" + area;
						areaElm.textContent = area;
						gameElm.appendChild(areaElm);
					}
					if (gameElm.children.length > 0) {
						areaSelect.appendChild(gameElm);
					}
				}
				document
					.getElementById("searchForm")
					.addEventListener("submit", searchQuotes);
				document
					.getElementById("randomBtn")
					.addEventListener("click", randomQuote);
				gameSelect.addEventListener("change", (e) => {
					for (let game of Object.keys(games)) {
						let elm = document.getElementById(
							"areaSelectGroup" + game,
						);
						if (!elm) {
							continue;
						}
						elm.disabled =
							gameSelect.value !== "" &&
							gameSelect.value !== game;
						if (elm.disabled && areaSelect.value.startsWith(game)) {
							areaSelect.value = "";
						}
					}
				});
			}

			function fixHashQuoteId(id) {
				let idParts = id.split(":", 3);
				if (idParts.length !== 3) {
					return id;
				} else if (idParts[2].length >= 3) {
					return id;
				} else {
					idParts[2] = ("000" + idParts[2]).substr(-3);
					return idParts.join(":");
				}
			}

			const init = async () => {
				await loadSpeakers();
				await loadQuotes();
				console.log("Loaded quotes");
				initUi();
				if (window.location.hash !== "") {
					specificQuote(
						fixHashQuoteId(window.location.hash.substring(1)),
					);
				} else {
					randomQuote();
				}

				window.addEventListener("hashchange", async (event) => {
					specificQuote(
						fixHashQuoteId(window.location.hash.substring(1)),
					);
				});
			};

			if (document.readyState === "loading") {
				window.addEventListener("DOMContentLoaded", init);
			} else {
				init();
			}
		</script>
	</body>
</html>
