<!doctype html>
<html lang="en" data-bs-theme="dark" class="min-vh-100">
	<head>
		<meta charset="utf-8" />
		<title>Little Big Adventure Game Quotes (&alpha;lpha)</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link
			rel="stylesheet"
			href="https://magicball.net/assets/css/bundle.css"
		/>
		<script async src="https://magicball.net/assets/js/bundle.js"></script>
		<style>
			.quote .message {
				/* Ensure newlines result in new lines */
				white-space: pre-line;
			}
		</style>
	</head>

	<body class="d-flex flex-column min-vh-100">
		<header
			class="navbar navbar-expand-lg sticky-top bg-body-secondary"
			_style="--bs-bg-opacity: .9;"
		>
			<nav class="container">
				<a class="navbar-brand" href="https://magicball.net">
					<picture>
						<source
							type="image/webp"
							srcset="https://magicball.net/assets/logo.webp"
						/>
						<img
							src="https://magicball.net/assets/logo.png"
							alt="Magicball Network"
							height="50"
						/>
					</picture>
				</a>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarSupportedContent"
					aria-controls="navbarSupportedContent"
					aria-expanded="false"
					aria-label="Toggle navigation"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div
					class="collapse navbar-collapse"
					id="navbarSupportedContent"
				>
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
						<li class="nav-item text-nowrap">
							<a
								class="nav-link icon-link"
								href="https://magicball.net"
							>
								<img
									src="https://magicball.net/assets/favicon-64.png"
									class="nav-icon"
									height="24"
									width="24"
									alt=""
									aria-hidden="true"
								/>
								Home
							</a>
						</li>
						<li class="nav-item text-nowrap">
							<a
								class="nav-link icon-link"
								href="https://forums.magicball.net"
							>
								<img
									src="https://magicball.net/assets/talk.png"
									class="nav-icon"
									height="24"
									width="24"
									alt=""
									aria-hidden="true"
								/>
								Forum
							</a>
						</li>
						<li class="nav-item text-nowrap">
							<a class="nav-link icon-link" href="/">
								<img
									src="quotes.png"
									class="nav-icon"
									height="24"
									width="24"
									alt=""
									aria-hidden="true"
								/>
								Game quotes
							</a>
						</li>
					</ul>
				</div>
			</nav>
		</header>

		<main class="flex-column">
			<div
				class="container bg-body-secondary p-4 header-bg"
				style="background-image: url(headerbg.jpg)"
			>
				<div class="col-12 mx-auto text-center">
					<h1 class="no-anchor" data-toc-skip>
						Little Big Adventure Game Quotes <sup>&alpha;lpha</sup>
					</h1>
				</div>
				<div class="row">
					<div class="col-lg-6 mx-auto">
						This page allows you to search and browse through the
						text displayed in both LBA games. All the engine text is
						featured, but the information is incomplete. Quotes are
						missing information on who said it, and their more exact
						location. You can suggest edits by submitting merge
						requests on logging issues on the
						<a href="https://github.com/magicball-network/quotes"
							>Github project</a
						>.
					</div>
				</div>
			</div>

			<div class="container bg-body-tertiary py-2">
				<div
					class="row"
					style="position: sticky; top: 76px; z-index: 10"
				>
					<div class="pt-2 bg-body-tertiary">
						<section class="mx-auto col-md-12 col-lg-8 col-xl-6">
							<div class="input-group mb-1">
								<label
									for="gameSelect"
									class="col-sm-2 input-group-text"
									>Game</label
								>
								<select id="gameSelect" class="form-select">
									<option value="">Any</option>
								</select>
							</div>
							<div class="input-group mb-1">
								<label
									for="areaSelect"
									class="col-sm-2 input-group-text"
									>Area</label
								>
								<select id="areaSelect" class="form-select">
									<option value="">Any</option>
								</select>
							</div>
							<div class="input-group mb-1">
								<label
									for="search"
									class="col-sm-2 input-group-text"
									>Search</label
								>
								<input
									id="search"
									placeholder="Search for a quote"
									type="text"
									class="form-control"
								/>
								<button
									id="searchBtn"
									type="button"
									class="btn btn-primary"
								>
									Search
								</button>

								<button
									id="randomBtn"
									type="button"
									class="btn btn-success"
								>
									Random
								</button>
							</div>
						</section>
					</div>
					<div
						class="p-2"
						style="
							background: linear-gradient(
								to bottom,
								rgba(
										var(--bs-tertiary-bg-rgb),
										var(--bs-bg-opacity)
									)
									0%,
								rgba(0, 0, 0, 0) 100%
							);
						"
					></div>
				</div>
				<div class="row" style="z-index: 0">
					<section id="quotes"></section>
				</div>
			</div>
		</main>

		<div class="footer mt-auto bg-body-secondary">
			<footer
				class="container d-flex flex-wrap justify-content-between align-items-center pt-3"
			>
				<p class="col-md-4">
					Service provided by
					<a href="https://magicball.net">Magicball Network</a>
				</p>

				<a
					href="/"
					class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto text-decoration-none"
				>
					<img
						src="https://magicball.net/assets/favicon-32.png"
						alt="Home"
					/>
				</a>

				<p class="col-md-4 text-end">
					Project hosted on
					<a href="https://github.com/magicball-network/quotes"
						>Github</a
					>
				</p>
			</footer>
		</div>

		<script id="tmpl-quote" type="x-tmpl-mustache">
			<div class="card quote mb-2">
				<div class="card-body">
					<dl class="row mb-0">
						<dt class="col-md-2 col-lg-1">Game</dt>
						<dd class="col-md-10 col-lg-11">{{ game }}</dd>
						<dt class="col-md-2 col-lg-1">Quote ID</dt>
						<dd class="col-md-10 col-lg-11">
							<a href="#{{fqnId}}">{{ id }}</a>
							<a href="https://github.com/magicball-network/quotes/blob/main/{{ game }}/{{ source }}.json"
								class="text-decoration-none"
								target="_blank"
								title="Edit source"
								>‚úè</a
							>
						</dd>
						<dt class="col-md-2 col-lg-1">Area</dt>
						<dd class="col-md-10 col-lg-11">{{ area }}</dd>
						{{#location}}
						<dt class="col-md-2 col-lg-1">Location</dt>
						<dd class="col-md-10 col-lg-11">{{ location }}</dd>
						{{/location}}
						{{#speaker}}
						<dt class="col-md-2 col-lg-1">Speaker</dt>
						<dd class="col-md-10 col-lg-11">{{ speaker }}</dd>
						{{/speaker}}
						<dt class="col-md-2 col-lg-1">Quote</dt>
						<dd class="col-md-10 col-lg-11 message">{{ message }}</dd>
					</dl>
				</div>
			</div>
		</script>

		<script type="module">
			import * as Mustache from "mustache";
			window.Mustache = Mustache;
		</script>

		<script>
			const games = {
				lba1: "Little Big Adventure 1 / Relentless",
				lba2: "Little Big Adventure 2 / Twinsen's Odyssey",
			};
			const quotes = [];
			const quoteIndex = {};
			const areaMap = {};

			async function retrieveQuotes(game) {
				areaMap[game] = new Set();
				let response = await fetch(game + ".json");
				if (response.ok) {
					for (let quote of await response.json()) {
						quote["fqnId"] = game + ":" + quote.id;
						quote["game"] = game;
						quotes.push(quote);
						quoteIndex[quote.fqnId] = quote;
						areaMap[game].add(quote.area);
					}
				} else {
					console.error(
						"Loading quotes for {} failed: {}",
						game,
						response,
					);
				}
			}

			async function loadQuotes() {
				return Promise.all([
					retrieveQuotes("lba1"),
					retrieveQuotes("lba2"),
				]);
			}

			function clearQuotes() {
				document.getElementById("quotes").innerHTML = "";
			}

			function renderQuote(target, quote) {
				const rendered = Mustache.render(
					document.getElementById("tmpl-quote").innerHTML,
					quote,
				);
				target.innerHTML += rendered;
			}

			function matchesQuote(quote, params) {
				if (!quote) {
					return false;
				}
				if (!params) {
					return true;
				}
				if (params.area) {
					let area = params.area.split(":", 2);
					if (
						!area ||
						quote.game !== area[0] ||
						quote.area !== area[1]
					) {
						return false;
					}
				} else if (params.game && params.game !== quote.game) {
					return false;
				}
				if (
					params.query &&
					!quote.message
						.toLowerCase()
						.includes(params.query.toLowerCase())
				) {
					return false;
				}
				return true;
			}

			function findQuotes(params) {
				const target = document.getElementById("quotes");
				let cnt = 0;
				for (let quote of quotes) {
					if (matchesQuote(quote, params)) {
						renderQuote(target, quote);
						++cnt;
					}
					if (cnt >= 50) {
						break;
					}
				}
			}

			function searchQuotes() {
				const query = document.getElementById("search").value;
				if (!query) {
					return;
				}
				clearQuotes();
				findQuotes({
					game: document.getElementById("gameSelect").value,
					area: document.getElementById("areaSelect").value,
					query: query,
				});
			}

			function randomQuote() {
				const params = {
					game: document.getElementById("gameSelect").value,
					area: document.getElementById("areaSelect").value,
				};
				while (true) {
					let idx = Math.round(Math.random() * quotes.length);
					let quote = quotes[idx];
					if (matchesQuote(quote, params)) {
						clearQuotes();
						renderQuote(document.getElementById("quotes"), quote);
						return;
					}
				}
			}

			function initUi() {
				const gameSelect = document.getElementById("gameSelect");
				for (let game of Object.keys(games)) {
					const gameElm = document.createElement("option");
					gameElm.value = game;
					gameElm.textContent = games[game];
					gameSelect.appendChild(gameElm);
				}
				const areaSelect = document.getElementById("areaSelect");
				for (let game of Object.keys(areaMap)) {
					const gameElm = document.createElement("optgroup");
					gameElm.label = games[game];
					gameElm.id = "areaSelectGroup" + game;
					for (let area of areaMap[game]) {
						const areaElm = document.createElement("option");
						areaElm.value = game + ":" + area;
						areaElm.textContent = area;
						gameElm.appendChild(areaElm);
					}
					if (gameElm.children.length > 0) {
						areaSelect.appendChild(gameElm);
					}
				}
				document
					.getElementById("searchBtn")
					.addEventListener("click", searchQuotes);
				document
					.getElementById("randomBtn")
					.addEventListener("click", randomQuote);
				gameSelect.addEventListener("change", (e) => {
					for (let game of Object.keys(games)) {
						let elm = document.getElementById(
							"areaSelectGroup" + game,
						);
						if (!elm) {
							continue;
						}
						elm.disabled =
							gameSelect.value !== "" &&
							gameSelect.value !== game;
						if (elm.disabled && areaSelect.value.startsWith(game)) {
							areaSelect.value = "";
						}
					}
				});
			}

			const init = async () => {
				await loadQuotes();
				console.log("Loaded quotes");
				initUi();
				if (window.location.hash !== "") {
					let id = window.location.hash.substring(1);
					if (quoteIndex[id]) {
						renderQuote(
							document.getElementById("quotes"),
							quoteIndex[id],
						);
					}
				} else {
					randomQuote();
				}

				window.addEventListener("hashchange", async (event) => {
					clearQuotes();
					let id = window.location.hash.substring(1);
					if (quoteIndex[id]) {
						renderQuote(
							document.getElementById("quotes"),
							quoteIndex[id],
						);
					}
				});
			};

			if (document.readyState === "loading") {
				window.addEventListener("DOMContentLoaded", init);
			} else {
				init();
			}
		</script>
	</body>
</html>
